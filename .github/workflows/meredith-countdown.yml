name: Meredith Festival Countdown

on:
  schedule:
    # Runs at 5:00 PM Melbourne time (6:00 AM UTC same day)
    - cron: '0 6 * * *'
  workflow_dispatch: # Allows manual testing

jobs:
  send-countdown:
    runs-on: ubuntu-latest
    
    steps:
    - name: Send Daily Countdown
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "Sending Meredith countdown..."
        
        python3 << 'PYTHON_SCRIPT'
        import json
        import urllib.request
        import urllib.parse
        import os
        from datetime import datetime, timezone, timedelta
        import random
        
        # Get secrets from environment
        bot_token = os.environ['TELEGRAM_BOT_TOKEN']
        chat_id = os.environ['TELEGRAM_CHAT_ID']
        
        # Festival date: December 5, 2025
        melbourne_offset = timedelta(hours=11)
        melbourne_tz = timezone(melbourne_offset)
        now_melbourne = datetime.now(timezone.utc).astimezone(melbourne_tz)
        festival_date = datetime(2025, 12, 5, tzinfo=melbourne_tz)
        
        # Calculate days until festival
        days_until = (festival_date.date() - now_melbourne.date()).days
        
        # If festival has started or passed, don't send
        if days_until < 0:
            print("Festival has passed!")
            exit(0)
        
        # Artist lineup with YouTube video IDs
        artists = [
            {"name": "TV On The Radio", "video": "dQw4w9WgXcQ", "song": "Wolf Like Me"},
            {"name": "ATARASHII GAKKO!", "video": "gfIxtIa00yo", "song": "NAINAINAI"},
            {"name": "Perfume Genius", "video": "lt_EcoXHMpI", "song": "Queen"},
            {"name": "Chet Faker", "video": "hi4pzKvuEQM", "song": "Gold"},
            {"name": "Pa Salieu", "video": "OQENyIRx48o", "song": "Frontline"},
            {"name": "HAAi", "video": "hY-ScL9WJMU", "song": "Purple Jelly Disc"},
            {"name": "Bar Italia", "video": "gOBW8FdJjEs", "song": "Nurse!"},
            {"name": "Mildlife", "video": "TQ2vVwjYdeM", "song": "The Magnificent Moon"},
            {"name": "Folk Bitch Trio", "video": "ZqYRXl_eJ1Y", "song": "Crocodile"},
            {"name": "Colin Hay", "video": "J9gKyRmic20", "song": "Overkill"},
            {"name": "Omar Souleyman", "video": "lVlgMEFu1PI", "song": "Warni Warni"},
            {"name": "Ninajirachi", "video": "8kx-8qhxiME", "song": "Poison"},
            {"name": "RONA", "video": "dH8Afl07sYY", "song": "Boiler Room Set"},
            {"name": "Florist", "video": "qy9r9_zxS00", "song": "Red Bird Pt. 2"},
            {"name": "RP Boo", "video": "o8NyTowIJKc", "song": "Godzilla"},
        ]
        
        # Packing tips/reminders (one per day)
        packing_tips = [
            "ğŸª Don't forget your tent pegs and a mallet! The ground can be hard.",
            "ğŸ’§ Pack a reusable water bottle - staying hydrated is crucial in the Aussie summer!",
            "ğŸ”¦ Headlamp > flashlight. You'll need both hands free at night.",
            "ğŸ§´ SPF 50+ sunscreen. The Victorian sun doesn't mess around.",
            "ğŸ’ Bring a small day bag for carrying essentials around the festival.",
            "ğŸ§¥ Pack layers! Desert nights get cold even in summer.",
            "ğŸ‘Ÿ Comfy closed-toe shoes. Thongs are for the campsite only.",
            "ğŸ’Š Basic first aid kit: pain relief, bandaids, antihistamines.",
            "ğŸ”‹ Portable charger/power bank - your phone will die otherwise.",
            "ğŸ§» Toilet paper and hand sanitiser. Trust us on this.",
            "ğŸµ Earplugs for sleeping (ironic, we know).",
            "ğŸ´ Camping cutlery, plates, cups - and a can opener!",
            "ğŸ”¥ Matches or lighter for your camp stove.",
            "ğŸ’¼ Zip-lock bags to keep things dry and organized.",
            "ğŸŒ™ Camping chair - your back will thank you.",
            "ğŸ§¢ Wide-brimmed hat for sun protection.",
            "ğŸ©± Swimmers for spontaneous dips (it gets HOT).",
            "ğŸ—‘ï¸ Garbage bags - leave no trace!",
            "ğŸ’¤ Earplugs AND an eye mask for quality sleep.",
            "ğŸ» Don't forget your BYO drinks! (within limits)",
            "ğŸ“± Download offline maps of the festival grounds.",
            "ğŸ§´ After-sun cream or aloe vera gel.",
            "ğŸ­ Costume for The Gift! Get creative.",
            "ğŸ”¦ Glow sticks or LED lights to find your tent at night.",
            "ğŸ¶ Check the set times when they're released!",
            "ğŸš— Plan your route and check for road works.",
            "â›º Test your tent at home before you go!",
            "ğŸ¥ª Pre-make some easy camping meals.",
            "ğŸ’³ Cash for any festival purchases.",
            "ğŸ†” Don't forget your ID and ticket!",
        ]
        
        # Select artist for today (deterministic based on day)
        artist_index = days_until % len(artists)
        today_artist = artists[artist_index]
        
        # Select packing tip (deterministic based on day)
        tip_index = days_until % len(packing_tips)
        today_tip = packing_tips[tip_index]
        
        # Build message
        if days_until == 0:
            message = "ğŸ‰ *IT'S FESTIVAL DAY!* ğŸ‰\n\n"
            message += "MEREDITH IS HERE! Have an absolutely incredible time! ğŸŒŸ\n\n"
            message += "Stay safe, stay hydrated, and make some unforgettable memories! ğŸµâœ¨"
        else:
            message = f"ğŸª *MEREDITH COUNTDOWN* ğŸª\n\n"
            
            if days_until == 1:
                message += f"*TOMORROW IS THE DAY!* ğŸ‰\n\n"
            else:
                message += f"*{days_until} days until Meredith!* â°\n\n"
            
            message += f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            message += f"ğŸ“¦ *Daily Reminder:*\n{today_tip}\n\n"
            message += f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            message += f"ğŸµ *Artist of the Day: {today_artist['name']}*\n"
            message += f"Check out '{today_artist['song']}':\n"
            message += f"https://www.youtube.com/watch?v={today_artist['video']}\n\n"
            
            if days_until <= 7:
                message += "ğŸ”¥ *ONE WEEK TO GO!* Get excited! ğŸ”¥"
            elif days_until <= 14:
                message += "ğŸ¸ Two weeks away! Time to finalize your plans! ğŸ¸"
        
        # Send to Telegram
        telegram_url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
        data = urllib.parse.urlencode({
            'chat_id': chat_id,
            'text': message,
            'parse_mode': 'Markdown',
            'disable_web_page_preview': False
        }).encode()
        
        req = urllib.request.Request(telegram_url, data=data)
        
        try:
            with urllib.request.urlopen(req) as response:
                result = json.loads(response.read())
                if result.get('ok'):
                    print(f"âœ… Countdown sent! {days_until} days until Meredith!")
                else:
                    print(f"Telegram error: {result}")
        except Exception as e:
            print(f"Error sending to Telegram: {e}")
            exit(1)
        PYTHON_SCRIPT
