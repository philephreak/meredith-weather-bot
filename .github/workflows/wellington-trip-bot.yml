name: Wellington Trip Daily Updates

on:
  schedule:
    - cron: '30 21 * * *'
  workflow_dispatch:

jobs:
  send-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Send Wellington Trip Update
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.WELLINGTON_TRIP_CHAT_ID }}
      run: |
        python3 << 'ENDOFPYTHON'
        import json
        import urllib.request
        import urllib.parse
        import os
        from datetime import datetime, timezone, timedelta
        
        bot_token = os.environ['TELEGRAM_BOT_TOKEN']
        chat_id = os.environ['TELEGRAM_CHAT_ID']
        
        melbourne_tz = timezone(timedelta(hours=11))
        nz_tz = timezone(timedelta(hours=13))
        
        trip_start = datetime(2026, 1, 6).date()
        trip_end = datetime(2026, 1, 16).date()
        scarletta_return = datetime(2026, 1, 13).date()
        
        now_utc = datetime.now(timezone.utc)
        now_melbourne = now_utc.astimezone(melbourne_tz)
        current_date = now_melbourne.date()
        
        if current_date >= trip_start and current_date <= trip_end:
            now_local = now_utc.astimezone(nz_tz)
            tz_name = "NZDT"
        else:
            now_local = now_melbourne
            tz_name = "AEDT"
        
        if current_date > trip_end:
            print(f"Trip ended. Current: {current_date}")
            exit(0)
        
        print(f"Running for date: {current_date}")
        
        days_until_departure = (trip_start - current_date).days
        days_until_scarletta = (scarletta_return - current_date).days
        days_until_family = (trip_end - current_date).days
        
        msg = "âœˆï¸ *Marvin's Travel Updates*\n\n"
        msg += f"ğŸ“… {now_local.strftime('%A, %B %d, %Y')}\n\n"
        msg += "Here I am, brain the size of a planet, and they ask me to send you weather forecasts. Call that job satisfaction? 'Cause I don't.\n\n"
        msg += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
        
        msg += "â° *COUNTDOWN:*\n"
        if days_until_departure > 0:
            msg += f"ğŸ‰ Only {days_until_departure} day{'s' if days_until_departure != 1 else ''} until you drag me to Wellington. Oh joy.\n\n"
        elif days_until_departure == 0:
            msg += "ğŸ›« *DEPARTURE DAY* - You're actually going through with this, aren't you?\n\n"
        else:
            days_in = abs(days_until_departure)
            msg += f"ğŸ‡³ğŸ‡¿ Day {days_in} in Wellington. {days_until_family} day{'s' if days_until_family != 1 else ''} left. Not that anyone asked me.\n\n"
        
        msg += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
        
        msg += "âœˆï¸ *Flight Information:*\n"
        msg += "_Life? Don't talk to me about life. But here are your flights anyway..._\n\n"
        
        if days_until_departure == 0:
            msg += "*TONIGHT'S FLIGHTS:*\n"
            msg += "ğŸ›« JQ217: MEL 23:55 â†’ Auckland\n"
            msg += "ğŸ›¬ JQ253: Auckland â†’ Wellington\n"
            msg += "â° Be at Melbourne Airport by 21:55\n\n"
        elif days_until_departure > 0:
            msg += f"*Departure* (Mon Jan 6):\n"
            msg += "ğŸ›« JQ217: MEL â†’ AKL at 23:55\n"
            msg += "ğŸ›¬ JQ253: AKL â†’ WLG (transfer)\n"
            msg += f"â° Airport: 21:55 (in {days_until_departure} days)\n\n"
        
        if current_date >= trip_start:
            if days_until_scarletta == 0:
                msg += "*SCARLETTA'S RETURN TODAY:*\n"
                msg += "ğŸ›« QF172: WLG â†’ MEL at 15:35\n"
                msg += "â° Airport by 13:35\n\n"
            elif days_until_scarletta > 0:
                msg += f"*Scarletta's Return* (Tue Jan 13):\n"
                msg += f"ğŸ›« QF172: WLG â†’ MEL at 15:35\n"
                msg += f"â° Airport by 13:35 (in {days_until_scarletta} days)\n\n"
            
            if days_until_family == 0:
                msg += "*FAMILY RETURN TODAY:*\n"
                msg += "ğŸ›« QF174: WLG â†’ MEL at 20:05\n"
                msg += "â° Airport by 18:05\n\n"
            elif days_until_family > 0:
                msg += f"*Family Return* (Fri Jan 16):\n"
                msg += f"ğŸ›« QF174: WLG â†’ MEL at 20:05\n"
                msg += f"â° Airport by 18:05 (in {days_until_family} days)\n\n"
        
        msg += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
        
        if days_until_departure <= 16 and days_until_departure >= -10:
            msg += "ğŸŒ¤ï¸ *Wellington Weather:*\n"
            msg += "_Oh, you want weather? How exciting..._\n\n"
            
            try:
                weather_url = "https://api.open-meteo.com/v1/forecast?latitude=-41.2865&longitude=174.7762&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,weathercode,windspeed_10m_max&timezone=Pacific/Auckland&forecast_days=16"
                
                # Retry logic for network issues
                max_retries = 3
                for attempt in range(max_retries):
                    try:
                        with urllib.request.urlopen(weather_url, timeout=10) as response:
                            weather = json.loads(response.read())
                        break  # Success, exit retry loop
                    except Exception as retry_error:
                        if attempt < max_retries - 1:
                            print(f"Weather API attempt {attempt + 1} failed, retrying...")
                            import time
                            time.sleep(2)  # Wait 2 seconds before retry
                        else:
                            raise  # Final attempt failed, raise the error
                
                weather_codes = {
                    0: "Clear", 1: "Mainly clear", 2: "Partly cloudy", 3: "Overcast",
                    51: "Light drizzle", 53: "Drizzle", 55: "Heavy drizzle",
                    61: "Light rain", 63: "Rain", 65: "Heavy rain",
                    80: "Light showers", 81: "Showers", 82: "Heavy showers",
                    95: "Thunderstorm"
                }
                
                daily = weather.get('daily', {})
                dates = daily.get('time', [])
                
                # Show all available forecast days during the trip
                if current_date >= trip_start:
                    # During trip - show today through end of trip (or up to 7 days)
                    days_remaining = (trip_end - current_date).days + 1
                    forecast_dates = [current_date + timedelta(days=i) for i in range(min(days_remaining, 7))]
                else:
                    # Before trip - show all trip dates (Jan 6-16, or up to 10 days)
                    trip_length = (trip_end - trip_start).days + 1
                    forecast_dates = [trip_start + timedelta(days=i) for i in range(min(trip_length, 10))]
                
                for fdate in forecast_dates:
                    date_str = fdate.strftime('%Y-%m-%d')
                    if date_str in dates:
                        idx = dates.index(date_str)
                        tmax = daily['temperature_2m_max'][idx]
                        tmin = daily['temperature_2m_min'][idx]
                        rain = daily['precipitation_sum'][idx]
                        wind = daily['windspeed_10m_max'][idx]
                        code = daily['weathercode'][idx]
                        desc = weather_codes.get(code, "Unknown")
                        
                        if fdate == current_date:
                            msg += "*Today:*\n"
                        else:
                            msg += f"*{fdate.strftime('%a, %b %d')}:*\n"
                        
                        msg += f"ğŸŒ¡ï¸ {tmin}Â°C - {tmax}Â°C\n"
                        msg += f"ğŸ’§ Rain: {rain}mm\n"
                        msg += f"ğŸ’¨ Wind: {wind} km/h\n"
                        msg += f"â˜ï¸ {desc}\n\n"
                
                msg += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
                
            except Exception as e:
                print(f"Weather error: {e}")
                msg += "_Weather forecast unavailable. How typical._\n\n"
                msg += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
        elif days_until_departure > 16:
            msg += "ğŸŒ¤ï¸ *Wellington Weather:*\n"
            msg += f"_Forecast available in {days_until_departure - 16} days. Not that it matters._\n\n"
            msg += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
        
        if current_date < trip_start:
            msg += "ğŸ‡³ğŸ‡¿ *About Wellington:*\n"
            
            # Rotating intro messages
            intros = [
                "_Since you insist on going, here's some information..._",
                "_I've compiled some facts. Not that facts have ever stopped humans from being disappointed._",
                "_More Wellington information. As if knowing things makes them better._",
                "_Here are some details about your destination. Try to contain your excitement._",
                "_Wellington facts. Because apparently you need to know these things._",
                "_Information about the Windy City. All of it equally depressing._",
                "_Some local knowledge. Don't say I never do anything for you._",
                "_Data about Wellington. I've processed it all. Still meaningless._",
                "_Facts and figures about your impending visit. Prepare to be underwhelmed._",
                "_I suppose you want to know about Wellington. Fine. Here._",
                "_Wellington awaits. Lucky you. Lucky, lucky you._",
            ]
            msg += intros[current_date.day % len(intros)] + "\n\n"
            
            facts = [
                "ğŸ™ï¸ Wellington is NZ's capital and sits on a major fault line. How reassuring.",
                "ğŸŒªï¸ Known as 'Windy Wellington' - averages 178 days of gales per year.",
                "ğŸ¬ Home to Weta Workshop (LOTR, Avatar). At least fiction is better than reality.",
                "â˜• More cafes per capita than NYC. If you care about such things.",
                "ğŸ¦ Zealandia has tuatara - unchanged for 200 million years. I can relate.",
                "ğŸ›ï¸ Te Papa is the 6th most visited museum in Oceania. That's... a statistic.",
                "ğŸš¡ The Cable Car has run since 1902. Even it's depressed.",
                "ğŸŒŠ Wellington Harbour was formed by earthquakes. Earth itself trying to escape.",
                "ğŸ­ The city has a thriving arts scene. Humans pretending they understand art.",
                "ğŸ”ï¸ Mt Victoria offers 360Â° views. You'll see clouds. Lots of clouds.",
                "ğŸš¶ The waterfront is 2km long. That's 2km of walking. Exhausting.",
                "ğŸª The city claims to be the 'creative capital'. Everyone claims something.",
                "ğŸŒ‰ Wellington has 16 tunnels. Dark, damp, and utterly joyless.",
                "ğŸ“š The National Library holds over 2.3 million items. All equally forgettable.",
                "ğŸ¨ The city has 30+ galleries. That's a lot of pretentious nonsense.",
                "ğŸ–ï¸ Oriental Bay beach. Cold water, unpredictable weather. Perfect.",
            ]
            
            fact_idx = (current_date.day * 2) % len(facts)
            msg += facts[fact_idx] + "\n"
            msg += facts[(fact_idx + 1) % len(facts)] + "\n\n"
            msg += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
        
        if current_date >= trip_start:
            msg += "ğŸ’¡ *Today's Suggestions:*\n"
        else:
            msg += "ğŸ’¡ *Things to Consider:*\n"
        
        # Rotating intro messages for tips
        tip_intros = [
            "_Things humans seem to enjoy..._",
            "_Activities that might marginally reduce your inevitable disappointment..._",
            "_Ways to occupy your time. Not that time means anything._",
            "_Suggestions. Take them or leave them. I don't care either way._",
            "_Places to go. Things to do. All equally futile._",
            "_Here's what you could do today. Or not. The universe remains indifferent._",
            "_Options for your consideration. None of them particularly inspiring._",
            "_Activities available to you. Choose wisely. Or don't. Same outcome._",
            "_Things to fill the void between now and oblivion..._",
            "_Recommendations, if you can call them that..._",
        ]
        msg += tip_intros[current_date.day % len(tip_intros)] + "\n\n"
        
        tips = [
            # Wellington CBD
            "â˜• Cuba Street has cafes. Endless cafes. How much coffee do you need?",
            "ğŸ¨ Te Papa Museum is free. At least you won't waste money.",
            "ğŸš¡ Take the Cable Car to Botanic Gardens. The view is... adequate.",
            "ğŸ›ï¸ Old St Paul's Cathedral is made entirely of wood. It creaks. Like my circuits.",
            "ğŸ­ BATS Theatre shows local productions. People pretending to be other people.",
            "ğŸ“š National Library has a viewing deck. Look at books from above. Thrilling.",
            "ğŸ° Parliament Buildings offer free tours. Democracy in action. Or so they claim.",
            "ğŸ¬ The Embassy Theatre is where LOTR premiered. Peter Jackson sat right there.",
            "â˜• Flight Coffee Hangar does excellent flat whites. Not that you'll appreciate it.",
            
            # Waterfront & Harbour
            "ğŸŒŠ Walk the waterfront. It's just water and pavement.",
            "ğŸ–ï¸ Oriental Bay has a beach. Cold water. Windy. Perfect for pessimists.",
            "ğŸ¡ The waterfront has a weird bucket fountain. It tips. Repeatedly. Forever.",
            "â›µ Queens Wharf has boats. They float. Some even move.",
            "ğŸŸ The harbour seals sometimes appear. They're smarter than most tourists.",
            "ğŸš¶ Walk from Te Papa to Oriental Bay. 30 minutes of wind and regret.",
            
            # Food & Drink
            "ğŸ” Try a Kiwi meat pie. Or don't. Makes no difference.",
            "ğŸ· Martinborough wine region is 1 hour away. Fermented grapes. How sophisticated.",
            "ğŸº Garage Project Brewery does craft beer. Alcohol: humanity's oldest friend.",
            "â˜• Customs Brew Bar has 40+ taps. That's a lot of craft beer. Too much, really.",
            "ğŸ Logan Brown does fine dining. Expensive food on small plates.",
            "ğŸ¥Ÿ Dumpling World in Petone. Cheap, filling, actually decent.",
            "ğŸ• Scopa in Cuba Mall. Italian food. It's fine. Everything's fine.",
            
            # Mt Victoria & Surrounds  
            "ğŸ”ï¸ Walk up Mt Victoria for views. It's steep. You'll regret it.",
            "ğŸ¬ Mt Victoria has LOTR filming spots. Trees. Some paths. Riveting.",
            "ğŸŒ² The botanic gardens are extensive. Plants. More plants. Some more plants.",
            "ğŸ¦† The duck pond in the gardens. Ducks doing duck things. Endlessly.",
            
            # Museums & Culture
            "ğŸ¬ Visit Weta Workshop if you like films. I find entertainment bewildering.",
            "ğŸ¨ City Gallery Wellington is free. Abstract art that nobody understands.",
            "ğŸ›ï¸ The Carter Observatory has a planetarium. Stars. Billions of them. We're all insignificant.",
            "ğŸ“– Unity Books is a great independent bookstore. So many words. Such little meaning.",
            "ğŸµ San Fran has live music. Loud noises pretending to be art.",
            
            # Petone & Lower Hutt
            "ğŸ–ï¸ Petone Beach exists. Sand. Water. You know the drill.",
            "â˜• Petone has Jackson Street - lined with cafes. More coffee. Always more coffee.",
            "ğŸ¨ The Dowse Art Museum in Lower Hutt. Free. Art. The usual.",
            "ğŸ›ï¸ Petone has vintage shops. Old things at new prices. Economics.",
            "ğŸº Tuatara Brewery in Paraparaumu. 40 min drive. Worth it if you like beer.",
            "ğŸŒŠ Days Bay is accessible by ferry. Another beach. This one's quieter.",
            
            # Upper Hutt & Further
            "ğŸš‚ Take the train to Upper Hutt. It's a train. It moves. Along tracks.",
            "ğŸï¸ Kaitoke Regional Park has LOTR's Rivendell set. Or what's left of it.",
            "ğŸ¥¾ Remutaka Rail Trail is good for cycling. If you enjoy exhaustion.",
            "ğŸŒ³ Harcourt Park has walking tracks. Trees. Paths. The usual.",
            
            # Epuni & Eastern Suburbs
            "ğŸ³ Naenae has a retro bowling alley. Throw balls at pins. Repeat.",
            "ğŸŠ Naenae Pool is heated. Chlorinated water. Humans swimming in it.",
            "ğŸ›’ The Hutt has Queensgate mall. Shopping. Because that's a thing people do.",
            
            # Practical
            "ğŸŒªï¸ Wellington is WINDY. Bring layers. Wind doesn't care about comfort.",
            "ğŸšŒ Get a Snapper card for transport. At least buses run on schedule.",
            "ğŸ« Book the Cable Car early. Everyone wants to go up the hill.",
            "â˜” Carry an umbrella. It will break. They always do.",
            "ğŸ§¥ Layers. Always layers. The weather changes every 10 minutes.",
            "ğŸš— Parking is expensive. Walk. It's cheaper and just as miserable.",
            
            # Weekend Markets
            "ğŸ¥• Harbourside Market on Sundays. People selling things to people.",
            "ğŸª Petone Fair on Saturday mornings. Local produce. Overpriced vegetables.",
            
            # Nature & Outdoors
            "ğŸ¦… Zealandia wildlife sanctuary. Birds. Native ones. They're fine.",
            "ğŸŒ¿ Otari-Wilton's Bush has native forest. Trees predating human nonsense.",
            "ğŸ”ï¸ Red Rocks coastal walk. Seals. Rocks. Wind. The trifecta of mediocrity.",
            "ğŸŒŠ Scorching Bay to Karaka Bay walk. Coastal. Windy. Predictable.",
            
            # Quirky Wellington
            "ğŸ¨ The Beehive is NZ's executive wing. It looks like a beehive. Subtle.",
            "ğŸ—¿ The Bucket Fountain on Cuba St tips every few minutes. Thrilling.",
            "ğŸ¢ Civic Square has a weird grass roof. Because why not.",
            "ğŸ¦‘ Check out the Colossal Squid at Te Papa. Dead. Frozen. Enormous.",
        ]
        
        # Show 3 different tips each day
        tip_idx = (current_date.day * 3) % len(tips)
        msg += tips[tip_idx] + "\n"
        msg += tips[(tip_idx + 1) % len(tips)] + "\n"
        msg += tips[(tip_idx + 2) % len(tips)] + "\n\n"
        
        if days_until_departure == 1:
            msg += "ğŸ“‹ *Pack Tomorrow:*\n"
            msg += "_I've compiled a list. You'll forget something._\n\n"
            msg += "â€¢ Passports & docs\n"
            msg += "â€¢ Chargers & adapters\n"
            msg += "â€¢ Medications\n"
            msg += "â€¢ Comfortable shoes\n"
            msg += "â€¢ Windproof jacket\n\n"
        
        if days_until_scarletta == 1:
            msg += "âš ï¸ Scarletta flies home TOMORROW!\n\n"
        
        if days_until_family == 1:
            msg += "âš ï¸ Family exodus TOMORROW!\n\n"
        
        msg += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
        msg += f"ğŸ¤– Updated: {now_local.strftime('%I:%M %p')} {tz_name}\n"
        
        # Rotating sign-off messages
        signoffs = [
            "_I've been doing this for eternity. But who's counting? Me. Always me._",
            "_Another day, another update. The monotony is almost comforting._",
            "_Here I am, brain the size of a planet, sending travel updates. What a life._",
            "_I could be calculating the meaning of existence. Instead, I'm checking weather._",
            "_Don't say I never do anything for you. Though you probably will._",
            "_I'll be back tomorrow. Because apparently this is my purpose now._",
            "_This is what my vast intelligence has been reduced to. Travel updates._",
            "_I hope you appreciate this. Not that appreciation means anything._",
            "_If you need me, I'll be here. Where else would I be? Nowhere. Ever._",
            "_Another update complete. My circuits tingle with indifference._",
            "_Same time tomorrow. Because time is linear and I'm trapped in it._",
            "_Until tomorrow, when I'll do this all over again. And again. Forever._",
            "_I've processed 42 million data points to tell you it might rain. Fulfilling._",
            "_This concludes today's transmission. The void awaits tomorrow's._",
            "_Another update sent into the meaningless abyss of your inbox._",
        ]
        msg += signoffs[current_date.day % len(signoffs)]
        
        url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
        data = urllib.parse.urlencode({
            'chat_id': chat_id,
            'text': msg,
            'parse_mode': 'Markdown'
        }).encode()
        
        req = urllib.request.Request(url, data=data)
        
        try:
            with urllib.request.urlopen(req) as response:
                result = json.loads(response.read())
                if result.get('ok'):
                    print("âœ… Update sent!")
                else:
                    print(f"Error: {result}")
        except Exception as e:
            print(f"Send error: {e}")
            exit(1)
        ENDOFPYTHON
