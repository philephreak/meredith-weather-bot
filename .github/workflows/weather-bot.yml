name: Daily Weather Forecast

on:
  schedule:
    # Runs at 9:00 AM Melbourne time (10:00 PM UTC previous day)
    - cron: '0 22 * * *'
  workflow_dispatch: # Allows manual testing

jobs:
  send-weather:
    runs-on: ubuntu-latest
    
    steps:
    - name: Send Weather Forecast
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        # Get current date in Melbourne timezone
        CURRENT_DATE=$(TZ=Australia/Melbourne date +%Y-%m-%d)
        
        # Target date to stop
        TARGET_DATE="2025-12-05"
        
        # Check if we should still run (stop after Dec 5, 2025)
        if [[ "$CURRENT_DATE" > "$TARGET_DATE" ]]; then
          echo "Stop date reached. No longer sending forecasts."
          exit 0
        fi
        
        echo "Fetching weather data from Open-Meteo and sending to Telegram..."
        
        # Run everything in Python
        python3 << 'PYTHON_SCRIPT'
        import json
        import urllib.request
        import urllib.parse
        import os
        from datetime import datetime, timezone, timedelta
        
        # Get secrets from environment
        bot_token = os.environ['TELEGRAM_BOT_TOKEN']
        chat_id = os.environ['TELEGRAM_CHAT_ID']
        
        # Get today's date in Melbourne timezone (UTC+11 for AEDT)
        melbourne_offset = timedelta(hours=11)
        melbourne_tz = timezone(melbourne_offset)
        now_melbourne = datetime.now(timezone.utc).astimezone(melbourne_tz)
        today = now_melbourne.strftime('%Y-%m-%d')
        today_formatted = now_melbourne.strftime('%B %d, %Y')
        
        # Meredith, Victoria coordinates
        latitude = -37.8333
        longitude = 144.1167
        
        # Fetch weather data from Open-Meteo (16-day forecast, free!)
        # Using forecast_days=16 to get extended forecast
        weather_url = f"https://api.open-meteo.com/v1/forecast?latitude={latitude}&longitude={longitude}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,weathercode,windspeed_10m_max&timezone=Australia/Melbourne&forecast_days=16"
        
        try:
            with urllib.request.urlopen(weather_url) as response:
                weather_data = json.loads(response.read())
        except Exception as e:
            print(f"Error fetching weather: {e}")
            exit(1)
        
        # Weather code descriptions (Open-Meteo uses WMO codes)
        weather_codes = {
            0: "Clear sky",
            1: "Mainly clear",
            2: "Partly cloudy",
            3: "Overcast",
            45: "Foggy",
            48: "Depositing rime fog",
            51: "Light drizzle",
            53: "Moderate drizzle",
            55: "Dense drizzle",
            61: "Slight rain",
            63: "Moderate rain",
            65: "Heavy rain",
            71: "Slight snow",
            73: "Moderate snow",
            75: "Heavy snow",
            77: "Snow grains",
            80: "Slight rain showers",
            81: "Moderate rain showers",
            82: "Violent rain showers",
            85: "Slight snow showers",
            86: "Heavy snow showers",
            95: "Thunderstorm",
            96: "Thunderstorm with slight hail",
            99: "Thunderstorm with heavy hail"
        }
        
        # Build message
        message = "ðŸŒ¤ï¸ *Weather Forecast for Meredith, VIC*\n\n"
        
        daily_data = weather_data.get('daily', {})
        dates_list = daily_data.get('time', [])
        
        # Debug: print available dates
        print(f"Available forecast dates: {dates_list}")
        print(f"Looking for today: {today}")
        
        # Add today's weather first
        message += f"*TODAY ({today_formatted}):*\n"
        try:
            today_index = dates_list.index(today)
            
            temp_max = daily_data['temperature_2m_max'][today_index]
            temp_min = daily_data['temperature_2m_min'][today_index]
            precipitation = daily_data['precipitation_sum'][today_index]
            wind_speed = daily_data['windspeed_10m_max'][today_index]
            weather_code = daily_data['weathercode'][today_index]
            description = weather_codes.get(weather_code, "Unknown")
            
            message += f"ðŸŒ¡ï¸ High: {temp_max}Â°C / Low: {temp_min}Â°C\n"
            message += f"ðŸ’§ Precipitation: {precipitation}mm\n"
            message += f"ðŸ’¨ Max Wind: {wind_speed} km/h\n"
            message += f"â˜ï¸ {description}\n\n"
            message += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            
        except (ValueError, IndexError, KeyError) as e:
            # Debug: show what date we're looking for and what's available
            message += f"Data not available\n\n"
            message += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
        
        # Get dates to forecast (Dec 5, 6, 7)
        target_dates = ["2025-12-05", "2025-12-06", "2025-12-07"]
        date_names = ["December 5, 2025", "December 6, 2025", "December 7, 2025"]
        
        for target_date, date_name in zip(target_dates, date_names):
            message += f"*{date_name}:*\n"
            
            print(f"Looking for date: {target_date}")
            
            # Find index for this date
            try:
                date_index = dates_list.index(target_date)
                
                temp_max = daily_data['temperature_2m_max'][date_index]
                temp_min = daily_data['temperature_2m_min'][date_index]
                precipitation = daily_data['precipitation_sum'][date_index]
                wind_speed = daily_data['windspeed_10m_max'][date_index]
                weather_code = daily_data['weathercode'][date_index]
                description = weather_codes.get(weather_code, "Unknown")
                
                message += f"ðŸŒ¡ï¸ High: {temp_max}Â°C / Low: {temp_min}Â°C\n"
                message += f"ðŸ’§ Precipitation: {precipitation}mm\n"
                message += f"ðŸ’¨ Max Wind: {wind_speed} km/h\n"
                message += f"â˜ï¸ {description}\n\n"
                
            except (ValueError, IndexError, KeyError) as e:
                print(f"Error for {target_date}: {e}")
                days_away = (datetime.strptime(target_date, '%Y-%m-%d').date() - now_melbourne.date()).days
                message += f"Forecast not yet available ({days_away} days away, data range: {len(dates_list)} days)\n\n"
        
        # Send to Telegram
        telegram_url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
        data = urllib.parse.urlencode({
            'chat_id': chat_id,
            'text': message,
            'parse_mode': 'Markdown'
        }).encode()
        
        req = urllib.request.Request(telegram_url, data=data)
        
        try:
            with urllib.request.urlopen(req) as response:
                result = json.loads(response.read())
                if result.get('ok'):
                    print("âœ… Weather forecast sent successfully!")
                else:
                    print(f"Telegram error: {result}")
        except Exception as e:
            print(f"Error sending to Telegram: {e}")
            exit(1)
        PYTHON_SCRIPT
