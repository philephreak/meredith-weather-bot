name: Daily Weather Forecast

on:
  schedule:
    # Runs at 9:00 AM Melbourne time (11:00 PM UTC previous day)
    - cron: '0 23 * * *'
  workflow_dispatch: # Allows manual testing

jobs:
  send-weather:
    runs-on: ubuntu-latest
    
    steps:
    - name: Send Weather Forecast
      env:
        WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        # Get current date in Melbourne timezone
        CURRENT_DATE=$(TZ=Australia/Melbourne date +%Y-%m-%d)
        
        # Target date to stop
        TARGET_DATE="2025-12-05"
        
        # Check if we should still run (stop after Dec 5, 2025)
        if [[ "$CURRENT_DATE" > "$TARGET_DATE" ]]; then
          echo "Stop date reached. No longer sending forecasts."
          exit 0
        fi
        
        echo "Fetching weather data and sending to Telegram..."
        
        # Run everything in Python for simplicity
        python3 << 'PYTHON_SCRIPT'
        import json
        import urllib.request
        import urllib.parse
        import os
        from datetime import datetime
        
        # Get secrets from environment
        api_key = os.environ['WEATHER_API_KEY']
        bot_token = os.environ['TELEGRAM_BOT_TOKEN']
        chat_id = os.environ['TELEGRAM_CHAT_ID']
        
        # Fetch weather data
        weather_url = f"https://api.openweathermap.org/data/2.5/forecast?lat=-37.8333&lon=144.1167&appid={api_key}&units=metric"
        
        try:
            with urllib.request.urlopen(weather_url) as response:
                weather_data = json.loads(response.read())
        except Exception as e:
            print(f"Error fetching weather: {e}")
            exit(1)
        
        # Check for API errors
        if 'cod' in weather_data and str(weather_data['cod']) == '401':
            print("Error: Invalid API key")
            exit(1)
        
        # Build message
        message = "ðŸŒ¤ï¸ *Weather Forecast for Meredith, VIC*\n\n"
        
        dates = ["2025-12-05", "2025-12-06", "2025-12-07"]
        date_names = ["December 5, 2025", "December 6, 2025", "December 7, 2025"]
        
        for date, date_name in zip(dates, date_names):
            message += f"*{date_name}:*\n"
            
            # Find forecast for this date (around noon)
            found = False
            for item in weather_data.get('list', []):
                if date in item['dt_txt'] and '12:00:00' in item['dt_txt']:
                    temp = item['main']['temp']
                    humidity = item['main']['humidity']
                    description = item['weather'][0]['description'].title()
                    
                    message += f"ðŸŒ¡ï¸ Temp: {temp}Â°C\n"
                    message += f"ðŸ’§ Humidity: {humidity}%\n"
                    message += f"â˜ï¸ {description}\n\n"
                    found = True
                    break
            
            if not found:
                message += "Data not available\n\n"
        
        # Send to Telegram
        telegram_url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
        data = urllib.parse.urlencode({
            'chat_id': chat_id,
            'text': message,
            'parse_mode': 'Markdown'
        }).encode()
        
        req = urllib.request.Request(telegram_url, data=data)
        
        try:
            with urllib.request.urlopen(req) as response:
                result = json.loads(response.read())
                if result.get('ok'):
                    print("âœ… Weather forecast sent successfully!")
                else:
                    print(f"Telegram error: {result}")
        except Exception as e:
            print(f"Error sending to Telegram: {e}")
            exit(1)
        PYTHON_SCRIPT
