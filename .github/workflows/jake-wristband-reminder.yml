name: Jake Wristband Reminder

on:
  schedule:
    # Run every 5 minutes through a broad window
    - cron: "*/5 * 3-6 12 *"   # Dec 3â€“6 UTC covers Aus times for Dec 4â€“5
  workflow_dispatch:

jobs:
  remind-jake:
    runs-on: ubuntu-latest

    steps:
    - name: Send Wristband Reminder
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "Checking whether a wristband reminder should be sent..."

        python3 << 'PYTHON_SCRIPT'
        import json
        import urllib.request
        import urllib.parse
        import os
        from datetime import datetime, timezone, timedelta

        # Melbourne timezone (AEDT, UTC+11)
        MELB_TZ = timezone(timedelta(hours=11))

        # Targets
        MORNING_DATE = datetime(2025, 12, 5).date()
        EVENING_DATE = datetime(2025, 12, 4).date()

        # Morning times (every 5 mins, 16 messages)
        morning_times = [
            (4, 45), (4, 50), (4, 55),
            (5, 0), (5, 5), (5, 10), (5, 15), (5, 20),
            (5, 25), (5, 30), (5, 35), (5, 40), (5, 45),
            (5, 50), (5, 55),
            (6, 0),
        ]

        morning_messages = [
            "â° JAKE WAKE UP! WRISTBAND CHECK! DO YOU HAVE IT?! (Time to Face The Music...literally)",
            "ðŸš¨ JAKE! WRISTBAND! CHECK YOUR POCKET! CHECK YOUR BAG! (We're on the Highway to Hell if you forgot it)",
            "â€¼ï¸ MATE. WRISTBAND. NOW. Don't make me come over there! (You Shook Me All Night Long but did you pack your wristband?!)",
            "ðŸŽª JAKE FOR F*CK'S SAKE CHECK YOU HAVE YOUR WRISTBAND! (Don't Stop Me Now... from checking your wristband!)",
            "ðŸ’€ WRISTBAND STATUS: ??? JAKE STATUS: QUESTIONABLE. CONFIRM YOU HAVE IT! (Should I Stay or Should I Go... depends on that wristband mate)",
            "ðŸ”¥ JAKE! WRISTBAND IN HAND OR WE'RE SCREWED! (Every Breath You Take... make sure you're holding that wristband)",
            "ðŸ˜± JAKE THIS IS NOT A DRILL! WRISTBAND! SHOW ME THE WRISTBAND! (Come Together... with your f*cking wristband!)",
            "ðŸ†˜ JAKE! IF YOU DON'T HAVE THAT WRISTBAND I SWEAR TO GOD! (We're Not Gonna Take It... without your wristband!)",
            "ðŸš¨ðŸš¨ðŸš¨ EMERGENCY WRISTBAND CHECK! JAKE! RESPOND! DO YOU HAVE IT?! (Under Pressure... to remember your wristband!)",
            "âš ï¸ JAKE! WRISTBAND OR BUST! SERIOUS NOW MATE! (I Still Haven't Found What I'm Looking For... YOUR WRISTBAND!)",
            "ðŸ’¥ JAKE WHERE IS THE F*CKING WRISTBAND?! TELL ME YOU HAVE IT! (Smells Like Teen Spirit... or panic if you forgot it!)",
            "ðŸ”´ MATE THIS IS GETTING RIDICULOUS! WRISTBAND! NOW! (Back In Black... because you'll be back home without a wristband!)",
            "ðŸ’¢ JAKE I'M NOT JOKING ANYMORE! WRISTBAND CONFIRMATION REQUIRED! (Bohemian Rhapsody... is this the real life or did you forget your wristband?!)",
            "â˜ ï¸ LAST CHANCE JAKE! WRISTBAND! WHERE IS IT?! (Another One Bites The Dust... like your festival plans without a wristband!)",
            "ðŸ†˜ðŸ†˜ðŸ†˜ ABSOLUTE FINAL WARNING! JAKE! WRISTBAND! (Stairway to Heaven... or highway to hell without your wristband!)",
            "ðŸš¨ðŸš¨ðŸš¨ JAKE IF YOU DON'T HAVE THAT WRISTBAND WE'RE F*CKED! (Welcome to the Jungle... without a wristband you're not welcome anywhere!)",
        ]

        # Evening times (every 10 mins, 8 messages)
        evening_times = [
            (20, 55), (21, 5), (21, 15), (21, 25),
            (21, 35), (21, 45), (21, 55),
            (22, 0),
        ]

        evening_messages = [
            "ðŸŒ™ NIGHT CHECK! JAKE! DO YOU HAVE THE WRISTBAND FOR TOMORROW?! (Don't Dream It's Over... unless the wristband is packed!)",
            "ðŸ‘œ PACK THE WRISTBAND MATE! This is your 8:55pm-ish nightly panic message!",
            "âš ï¸ SERIOUSLY JAKE. PUT THE WRISTBAND IN THE BAG. NOW. (Stop right now, thank you very much...)",
            "ðŸŽ¸ NIGHT REMINDER! WRISTBAND! It's the most important part of your outfit.",
            "ðŸ“¢ YO JAKE! PLEASE CONFIRM THE WRISTBAND IS IN THE BAG. (This is a public service announcement.)",
            "ðŸ”¥ NIGHTLY WRISTBAND CHECK! If you forget it now you'll regret it at 5am!",
            "ðŸš¨ FINAL HOUR WRISTBAND CHECK! DO. YOU. HAVE. IT. (We will keep asking.)",
            "ðŸ’¤ LAST NIGHT REMINDER! If you forget it in the morning we're doomed.",
        ]

        # Current time in Melbourne
        now = datetime.now(timezone.utc).astimezone(MELB_TZ)
        today = now.date()
        time_key = (now.hour, now.minute)

        # Determine which schedule applies
        if today == MORNING_DATE and time_key in morning_times:
            message = morning_messages[morning_times.index(time_key)]
        elif today == EVENING_DATE and time_key in evening_times:
            message = evening_messages[evening_times.index(time_key)]
        else:
            print(f"Skipping â€“ current time {time_key} not in either schedule.")
            exit(0)

        # Send Telegram Message
        bot_token = os.environ['TELEGRAM_BOT_TOKEN']
        chat_id = os.environ['TELEGRAM_CHAT_ID']

        telegram_url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
        payload = urllib.parse.urlencode({
            "chat_id": chat_id,
            "text": message,
            "disable_web_page_preview": True,
        }).encode()

        req = urllib.request.Request(telegram_url, data=payload)

        try:
            with urllib.request.urlopen(req) as resp:
                result = json.loads(resp.read())
                if result.get("ok"):
                    print(f"âœ… Sent at {now.strftime('%I:%M %p')} Melbourne time.")
                else:
                    print("Telegram error:", result)
        except Exception as e:
            print("Error sending message:", e)
            exit(1)

        PYTHON_SCRIPT
